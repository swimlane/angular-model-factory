/**
 * modelFactory makes working with RESTful APIs in AngularJS easy
 * @version v0.0.4 - 2014-11-25
 * @link https://github.com/phxdatasec/modelFactory
 * @author Austin McDaniel <amcdaniel2@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a,b){"use strict";!function(a){function b(a,b){a.super_=b,a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})}function d(a,b){Object.defineProperty(this,"kind",{value:a,enumerable:!0}),b&&b.length&&Object.defineProperty(this,"path",{value:b,enumerable:!0})}function e(a,b,c){e.super_.call(this,"E",a),Object.defineProperty(this,"lhs",{value:b,enumerable:!0}),Object.defineProperty(this,"rhs",{value:c,enumerable:!0})}function f(a,b){f.super_.call(this,"N",a),Object.defineProperty(this,"rhs",{value:b,enumerable:!0})}function g(a,b){g.super_.call(this,"D",a),Object.defineProperty(this,"lhs",{value:b,enumerable:!0})}function h(a,b,c){h.super_.call(this,"A",a),Object.defineProperty(this,"index",{value:b,enumerable:!0}),Object.defineProperty(this,"item",{value:c,enumerable:!0})}function i(a,b,c){var d=a.slice((c||b)+1||a.length);return a.length=0>b?a.length+b:b,a.push.apply(a,d),a}function j(b,c,d,k,l,m,n){l=l||[];var o=l.slice(0);if("undefined"!=typeof m){if(k&&k(o,m))return;o.push(m)}var p=typeof b,q=typeof c;if("undefined"===p)"undefined"!==q&&d(new f(o,c));else if("undefined"===q)d(new g(o,b));else if(p!==q)d(new e(o,b,c));else if(b instanceof Date&&c instanceof Date&&b-c!==0)d(new e(o,b,c));else if("object"===p&&null!==b&&null!==c){if(n=n||[],n.indexOf(b)<0){if(n.push(b),Array.isArray(b)){{var r;b.length}for(r=0;r<b.length;r++)r>=c.length?d(new h(o,r,new g(a,b[r]))):j(b[r],c[r],d,k,o,r,n);for(;r<c.length;)d(new h(o,r,new f(a,c[r++])))}else{var s=Object.keys(b),t=Object.keys(c);s.forEach(function(e){var f=t.indexOf(e);f>=0?(j(b[e],c[e],d,k,o,e,n),t=i(t,f)):j(b[e],a,d,k,o,e,n)}),t.forEach(function(b){j(a,c[b],d,k,o,b,n)})}n.length=n.length-1}}else b!==c&&("number"===p&&isNaN(b)&&isNaN(c)||d(new e(o,b,c)))}function k(b,c,d,e){return e=e||[],j(b,c,function(a){a&&e.push(a)},d),e.length?e:a}function l(a,b,c){if(c.path&&c.path.length){var d,e=a[b],f=c.path.length-1;for(d=0;f>d;d++)e=e[c.path[d]];switch(c.kind){case"A":l(e[c.path[d]],c.index,c.item);break;case"D":delete e[c.path[d]];break;case"E":case"N":e[c.path[d]]=c.rhs}}else switch(c.kind){case"A":l(a[b],c.index,c.item);break;case"D":a=i(a,b);break;case"E":case"N":a[b]=c.rhs}return a}function m(a,b,c){if(a&&b&&c&&c.kind){for(var d=a,e=-1,f=c.path.length-1;++e<f;)"undefined"==typeof d[c.path[e]]&&(d[c.path[e]]="number"==typeof c.path[e]?new Array:{}),d=d[c.path[e]];switch(c.kind){case"A":l(d[c.path[e]],c.index,c.item);break;case"D":delete d[c.path[e]];break;case"E":case"N":d[c.path[e]]=c.rhs}}}function n(a,b,c){if(c.path&&c.path.length){var d,e=a[b],f=c.path.length-1;for(d=0;f>d;d++)e=e[c.path[d]];switch(c.kind){case"A":n(e[c.path[d]],c.index,c.item);break;case"D":e[c.path[d]]=c.lhs;break;case"E":e[c.path[d]]=c.lhs;break;case"N":delete e[c.path[d]]}}else switch(c.kind){case"A":n(a[b],c.index,c.item);break;case"D":a[b]=c.lhs;break;case"E":a[b]=c.lhs;break;case"N":a=i(a,b)}return a}function o(a,b,c){if(a&&b&&c&&c.kind){var d,e,f=a;for(e=c.path.length-1,d=0;e>d;d++)"undefined"==typeof f[c.path[d]]&&(f[c.path[d]]={}),f=f[c.path[d]];switch(c.kind){case"A":n(f[c.path[d]],c.index,c.item);break;case"D":f[c.path[d]]=c.lhs;break;case"E":f[c.path[d]]=c.lhs;break;case"N":delete f[c.path[d]]}}}function p(a,b,c){if(a&&b){var d=function(d){(!c||c(a,b,d))&&m(a,b,d)};j(a,b,d)}}var q,r,s=[];q="object"==typeof global&&global?global:"undefined"!=typeof window?window:{},r=q.DeepDiff,r&&s.push(function(){"undefined"!=typeof r&&q.DeepDiff===k&&(q.DeepDiff=r,r=a)}),b(e,d),b(f,d),b(g,d),b(h,d),Object.defineProperties(k,{diff:{value:k,enumerable:!0},observableDiff:{value:j,enumerable:!0},applyDiff:{value:p,enumerable:!0},applyChange:{value:m,enumerable:!0},revertChange:{value:o,enumerable:!0},isConflict:{get:function(){return"undefined"!=typeof r},enumerable:!0},noConflict:{value:function(){return s&&(s.forEach(function(a){a()}),s=null),k},enumerable:!0}}),"undefined"!=typeof c&&c&&"object"==typeof exports&&exports&&c.exports===exports?c.exports=k:q.DeepDiff=k}(),function(a,b){"function"==typeof define&&define.amd?define([],b):"undefined"!=typeof c&&c.exports?c.exports=b():a.UriTemplate=b()}(this,function(){function a(a){return encodeURI(a).replace(/%25[0-9][0-9]/g,function(a){return"%"+a.substring(3)})}function c(c){var d="";e[c.charAt(0)]&&(d=c.charAt(0),c=c.substring(1));var g="",h="",i=!0,j=!1,k=!1;"+"==d?i=!1:"."==d?(h=".",g="."):"/"==d?(h="/",g="/"):"#"==d?(h="#",i=!1):";"==d?(h=";",g=";",j=!0,k=!0):"?"==d?(h="?",g="&",j=!0):"&"==d&&(h="&",g="&",j=!0);for(var l=[],m=c.split(","),n=[],o={},p=0;p<m.length;p++){var q=m[p],r=null;if(-1!=q.indexOf(":")){var s=q.split(":");q=s[0],r=parseInt(s[1])}for(var t={};f[q.charAt(q.length-1)];)t[q.charAt(q.length-1)]=!0,q=q.substring(0,q.length-1);var u={truncate:r,name:q,suffices:t};n.push(u),o[q]=u,l.push(q)}var v=function(b){for(var c="",d=0,e=0;e<n.length;e++){var f=n[e],l=b(f.name);if(null==l||Array.isArray(l)&&0==l.length||"object"==typeof l&&0==Object.keys(l).length)d++;else if(c+=e==d?h:g||",",Array.isArray(l)){j&&(c+=f.name+"=");for(var m=0;m<l.length;m++)m>0&&(c+=f.suffices["*"]?g||",":",",f.suffices["*"]&&j&&(c+=f.name+"=")),c+=i?encodeURIComponent(l[m]).replace(/!/g,"%21"):a(l[m])}else if("object"==typeof l){j&&!f.suffices["*"]&&(c+=f.name+"=");var o=!0;for(var p in l)o||(c+=f.suffices["*"]?g||",":","),o=!1,c+=i?encodeURIComponent(p).replace(/!/g,"%21"):a(p),c+=f.suffices["*"]?"=":",",c+=i?encodeURIComponent(l[p]).replace(/!/g,"%21"):a(l[p])}else j&&(c+=f.name,k&&""==l||(c+="=")),null!=f.truncate&&(l=l.substring(0,f.truncate)),c+=i?encodeURIComponent(l).replace(/!/g,"%21"):a(l)}return c},w=function(a,c){if(h){if(a.substring(0,h.length)!=h)return null;a=a.substring(h.length)}if(1==n.length&&n[0].suffices["*"]){for(var d=n[0],e=d.name,f=d.suffices["*"]?a.split(g||","):[a],k=i&&-1!=a.indexOf("="),l=1;l<f.length;l++){var a=f[l];k&&-1==a.indexOf("=")&&(f[l-1]+=(g||",")+a,f.splice(l,1),l--)}for(var l=0;l<f.length;l++){var a=f[l];i&&-1!=a.indexOf("=")&&(k=!0);for(var m=a.split(","),p=0;p<m.length;p++)i&&(m[p]=decodeURIComponent(m[p]));f[l]=1==m.length?m[0]:m}if(j||k){for(var q=c[e]||{},p=0;p<f.length;p++){var r=a;if("string"==typeof f[p]){var a=f[p],s=a.split("=",1)[0],a=a.substring(s.length+1);r=a}else{var a=f[p][0],s=a.split("=",1)[0],a=a.substring(s.length+1);f[p][0]=a,r=f[p]}q[s]!==b?Array.isArray(q[s])?q[s].push(r):q[s]=[q[s],r]:q[s]=r}c[e]=1==Object.keys(q).length&&q[e]!==b?q[e]:q}else c[e]=c[e]!==b?Array.isArray(c[e])?c[e].concat(f):[c[e]].concat(f):1!=f.length||d.suffices["*"]?f:f[0]}else{for(var f=1==n.length?[a]:a.split(g||","),t={},l=0;l<f.length;l++){for(var u=0;u<n.length-1&&l>u&&!n[u].suffices["*"];u++);if(u!=l){for(var v=n.length-1;v>0&&n.length-v<f.length-l&&!n[v].suffices["*"];v--);t[l]=n.length-v!=f.length-l?u:v}else t[l]=l}for(var l=0;l<f.length;l++){var a=f[l],m=a.split(",");if(j){var a=m[0],e=a.split("=",1)[0],a=a.substring(e.length+1);m[0]=a;var d=o[e]||n[0]}else var d=n[t[l]],e=d.name;for(var p=0;p<m.length;p++)i&&(m[p]=decodeURIComponent(m[p]));c[e]=(j||d.suffices["*"])&&c[e]!==b?Array.isArray(c[e])?c[e].concat(m):[c[e]].concat(m):1!=m.length||d.suffices["*"]?m:m[0]}}};return v.varNames=l,{prefix:h,substitution:v,unSubstitution:w}}function d(a){if(!(this instanceof d))return new d(a);for(var e=a.split("{"),f=[e.shift()],g=[],h=[],i=[],j=[];e.length>0;){var k=e.shift(),l=k.split("}")[0],m=k.substring(l.length+1),n=c(l);h.push(n.substitution),i.push(n.unSubstitution),g.push(n.prefix),f.push(m),j=j.concat(n.substitution.varNames)}this.fill=function(a){for(var b=f[0],c=0;c<h.length;c++){var d=h[c];b+=d(a),b+=f[c+1]}return b},this.fromUri=function(a){for(var c={},d=0;d<f.length;d++){var e=f[d];if(a.substring(0,e.length)!==e)return b;if(a=a.substring(e.length),d>=f.length-1){if(""==a)break;return b}for(var h=f[d+1],j=d;;){if(j==f.length-2){var k=a.substring(a.length-h.length);if(k!==h)return b;var l=a.substring(0,a.length-h.length);a=k}else if(h){var m=a.indexOf(h),l=a.substring(0,m);a=a.substring(m)}else if(g[j+1]){var m=a.indexOf(g[j+1]),l=a.substring(0,m);a=a.substring(m)}else{if(f.length>j+2){j++,h=f[j+1];continue}var l=a;a=""}break}i[d](l,c)}return c},this.varNames=j,this.template=a}var e={"+":!0,"#":!0,".":!0,"/":!0,";":!0,"?":!0,"&":!0},f={"*":!0};return d.prototype={toString:function(){return this.template},fillFromObject:function(a){return this.fill(function(b){return a[b]})}},d});var c=a.module("modelFactory",[]),d=a.forEach,e=a.extend,f=a.copy,g=["$$array","$save","$destroy","$pending","$revert","$diff","$extend"],h=["actions","instance","list","defaults","pk","stripTrailingSlashes","map"],i=function j(b){return d(arguments,function(c){c!==b&&d(c,function(c,d){-1===g.indexOf(d)&&(b[d]&&a.isObject(b[d])?j(b[d],c):a.isFunction(b[d])||(b[d]=c))})}),b};c.factory("$modelFactory",function(c,j,k,l){function m(k,m){function o(a){a.forEach(function(c,d){if(null!==c&&c!==b){var e=c.constructor===p?c:new p(c);e.$$array=a,a[d]=e}});var c=a.push;return a.push=function(b){b.constructor===p&&(b.$$array=a),c.apply(a,arguments)},m.list&&e(a,m.list),a}function p(a){var c,g=this;a===b&&(a={}),d(m.defaults,function(c,d){a[d]===b&&(a[d]="function"==typeof c?c(a):c)}),d(m.map,function(b,c){typeof b===p||typeof b===o?a[c]=new b(a[c]):"function"==typeof b?a[c]=b(a[c],a):(a[c]=a[c],delete a[c])}),d(m.actions,function(a,b){"$"===b[0]&&(g[b]=function(){return p.$buildRequest(b,a,g)})}),e(g,a),e(g,f(m.instance)),g.$save=function(){var a=p[g[m.pk]?"update":"post"](g);return g.$pending=!0,a.then(function(a){g.$pending=!1,i(g,a)},function(){g.$pending=!1}),a},g.$destroy=function(){var a=p.delete(g);return g.$pending=!0,a.then(function(){g.$pending=!1;var a=g.$$array;a&&a.splice(a.indexOf(g),1)},function(){g.$pending=!1}),a},g.$diff=function(){return DeepDiff.deep(c,g,function(a,b){return"$"===b[0]})},g.$revert=function(){return g.$extend(c)},g.$extend=function(a){return i(g,a),g},c=f(a)}var q={};return m=i({},f(n),m),p.$cache=l(k),d(m.actions,function(a,b){"base"!==b&&"$"!==b[0]&&(p[b]=function(){var c=Array.prototype.slice.call(arguments);return p.$buildRequest.apply(this,[b,a].concat(c))})}),p.$buildRequest=function(b,c,d,g){var h=f(m.actions.base);e(h,f(c)),h.cache===!0&&(h.cache=p.$cache);var i="";if(h.override)i=h.url;else if(i=k,h.url&&(i+="/"+h.url),("get"===b||"post"===b||"update"===b||"delete"===b)&&(i+="/{"+m.pk+"}"),"GET"===h.method&&(a.isString(d)||a.isNumber("number"))){var j={};j[m.pk]=d,d=j,g&&(d.param=g,i+="{?param*}")}else"GET"===h.method&&a.isObject(d)&&(d={param:d},i+="{?param*}");return h.url=p.$url(i,d),h.data=d,p.$call(h)},p.$call=function(a){var d=a.method+":"+a.url;if(q[d])return q[d];var e=j.defer();return q[d]=e.promise,a.data=f(a.data),a.beforeRequest&&a.beforeRequest(a),a.data=p.$strip(a.data),c(a).success(function(c){a.afterRequest&&a.afterRequest(c),a.invalidateCache&&p.$cache.removeAll(),e.resolve(a.wrap?a.isArray?new p.List(c):new p(c):c),q[d]=b}).error(function(a){q[d]=b,e.reject(a)}),e.promise},p.$url=function(a,b){var c=new UriTemplate(a||k).fillFromObject(b||{});return m.stripTrailingSlashes&&(c=c.replace(/\/+$/,"")||"/"),c},p.$strip=function(a){return a&&"object"==typeof a&&d(a,function(b,c){g.indexOf(c)>-1&&delete a[c]}),a},d(m,function(a,b){-1===h.indexOf(b)&&(p[b]=a)}),p.List=o,p}var n={pk:"id",stripTrailingSlashes:!0,defaults:{},map:{},actions:{base:{wrap:!0,beforeRequest:b,afterRequest:b,cache:!1},get:{method:"GET"},query:{method:"GET",isArray:!0},post:{method:"POST",invalidateCache:!0},update:{method:"PUT",invalidateCache:!0},"delete":{method:"DELETE",invalidateCache:!0}},instance:{},list:{}};return m})}(angular);