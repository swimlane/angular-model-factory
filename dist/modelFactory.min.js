/**
 * modelFactory makes working with RESTful APIs in AngularJS easy! 
 * @version v0.0.1 - 2014-10-24
 * @link https://github.com/phxdatasec/modelFactory
 * @author amcdnl
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(a,b){"use strict";var c=a.module("core.model",["utils.diff"]),d=a.forEach,e=a.extend,f=a.copy,g=function h(a){return d(arguments,function(b){b!==a&&d(b,function(b,c){a[c]&&a[c].constructor&&a[c].constructor===Object?h(a[c],b):a[c]=b})}),a};return c.factory("$modelFactory",function(c,h,i,j){function k(i,k){function n(a){a.forEach(function(b,c){var d=b.constructor===o?b:new o(b);d.$array=a,a[c]=d});var b=a.push;return a.push=function(c){c.constructor===o&&(c.$array=a),b.apply(a,arguments)},k.list&&e(a,k.list),a}function o(a){var c,g=this;a===b&&(a={}),d(k.defaults,function(c,d){a[d]===b&&(a[d]="function"==typeof c?c(a):c)}),d(k.map,function(b,c){typeof b===o||typeof b===n?a[c]=new b(a[c]):"function"==typeof b?a[c]=b(a[c],a):(a[c]=a[c],delete a[c])}),d(k.actions,function(a,b){"$"===b[0]&&(g[b]=function(){return o.$buildRequest(b,a,g)})}),e(g,a),e(g,f(k.instance)),g.$save=function(){var a=o[g[k.pk]?"update":"post"](g);return g.$pending=!0,a.then(function(a){g.$pending=!1,e(g,a)}),a},g.$destroy=function(){var a=o.delete(g);return g.$pending=!0,a.then(function(){g.$pending=!1;var a=g.$array;a&&a.splice(a.indexOf(g),1)}),a},g.$diff=function(){return DeepDiff.deep(c,g,function(a,b){return"$"===b[0]})},g.$revert=function(){return e(g,c),g},c=f(a)}var p={};return k=g({},f(l),k),o.$cache=j(i),d(k.actions,function(a,b){"base"!==b&&"$"!==b[0]&&(o[b]=function(){var c=Array.prototype.slice.call(arguments);return o.$buildRequest.apply(this,[b,a].concat(c))})}),o.$buildRequest=function(b,c,d,g){var h=f(k.actions.base);e(h,f(c)),h.cache===!0&&(h.cache=o.$cache);var j="";if(h.override)j=h.url;else if(j=i,h.url&&(j+="/"+h.url),("get"===b||"post"===b||"update"===b||"delete"===b)&&(j+="/{"+k.pk+"}"),"GET"===h.method&&(a.isString(d)||a.isNumber("number"))){var l={};l[k.pk]=d,d=l,g&&(d.param=g,j+="{?param*}")}else"GET"===h.method&&a.isObject(d)&&(d={param:d},j+="{?param*}");return h.url=o.$url(j,d),h.data=d,o.$call(h)},o.$call=function(a){if(p[a.url])return p[a.url];var d=h.defer();return p[a.url]=d.promise,a.data=f(a.data),a.beforeRequest&&a.beforeRequest(a),a.data=o.$strip(a.data),c(a).success(function(c){a.afterRequest&&a.afterRequest(c),a.invalidateCache&&o.$cache.removeAll(),d.resolve(a.wrap?a.isArray?new o.List(c):new o(c):c),p[a.url]=b}).error(function(c){p[a.url]=b,d.reject(c)}),d.promise},o.$url=function(a,b){var c=new UriTemplate(a||i).fillFromObject(b||{});return k.stripTrailing&&(c=c.replace(/\/+$/,"")||"/"),c},o.$strip=function(a){return a&&"object"==typeof a&&d(a,function(b,c){m.indexOf(c)>-1&&delete a[c]}),a},d(k,function(a,b){-1===m.indexOf(b)&&(o[b]=a)}),o.List=n,o}var l={pk:"id",stripTrailingSlashes:!0,defaults:{},map:{},actions:{base:{wrap:!0,beforeRequest:b,afterRequest:b,cache:!1},get:{method:"GET"},query:{method:"GET",isArray:!0},post:{method:"POST",invalidateCache:!0},update:{method:"PUT",invalidateCache:!0},"delete":{method:"DELETE",invalidateCache:!0}},instance:{},list:{}},m=["$array","$save","$destroy","$pending","$revert","$diff"];return k}),c}(angular);